'use client'
import { useEffect, useState } from 'react'; import { supabase } from '../../lib/supabase'; import Section from '../../components/Section'
export default function MemberDashboard(){ const [session,setSession]=useState(null); const [rows,setRows]=useState([]); const [msg,setMsg]=useState(null)
  useEffect(()=>{ supabase.auth.getSession().then(({data})=>setSession(data.session||null)); supabase.auth.onAuthStateChange((_e,s)=>setSession(s||null)) },[])
  useEffect(()=>{ if(!session) return; load() },[session])
  async function load(){ setMsg('Loading...'); const { data: { user } } = await supabase.auth.getUser(); if(!user){ setMsg('Not logged in'); return } const { data: ms, error } = await supabase.from('memberships').select('id, member_no, full_name, status, created_at').eq('user_id', user.id).order('created_at',{ascending:false}); if(error){ setMsg(error.message); return } const items=[]; for(const m of ms){ const r=await fetch('/api/member/signed-urls?membership_id='+m.id); const d=await r.json(); items.push({ ...m, ...d }) } setRows(items); setMsg(null) }
  if(!session) return (<Section title="Member Dashboard"><p>Please <a className="underline" href="/member/login">login</a>.</p></Section>)
  return (<Section title="Member Dashboard">{msg && <p className="text-sm">{msg}</p>}<table className="w-full text-sm border"><thead><tr className="bg-gray-50"><th className="th">Date</th><th className="th">Name</th><th className="th">Member No</th><th className="th">Status</th><th className="th">Downloads</th></tr></thead><tbody>{rows.map(r=>(<tr key={r.id}><td className="td">{new Date(r.created_at).toLocaleDateString()}</td><td className="td">{r.full_name}</td><td className="td">{r.member_no||'-'}</td><td className="td">{r.status}</td><td className="td">{r.status==='approved'? (<div className="flex gap-2">{r.idcard_url ? <a className="underline" href={r.idcard_url} target="_blank">ID Card</a> : null}{r.cert_url ? <a className="underline" href={r.cert_url} target="_blank">Certificate</a> : null}</div>) : 'â€”'}</td></tr>))}</tbody></table></Section>) }
